name: Nightly Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  nightly:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Build Release
        shell: pwsh
        run: |
          cargo build --release --verbose

      - name: Update Nightly Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $binary = "target/release/HtopRust.exe"
          if (-not (Test-Path $binary)) {
              Write-Error "Binary not found: $binary"
              exit 1
          }

          # Delete existing nightly release and tag if they exist
          gh release delete nightly --cleanup-tag -y 2>$null || Write-Host "No existing nightly release to delete"

          # Create new nightly release
          gh release create nightly $binary --title "Nightly Build" --notes "Latest build from commit $env:GITHUB_SHA" --prerelease
